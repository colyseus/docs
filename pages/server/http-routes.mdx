import { Callout, Cards } from "nextra/components";

# HTTP and API Routes

<Callout type="info">
    Since Colyseus 0.17, we introduced another routing stack (a fork of [better-call](https://github.com/colyseus/better-call)) for client-facing API routes, which enables type inference of HTTP calls to the [Client SDK](/client#http-requests). You can use both Express or our own routing stack as you prefer.
</Callout>

Colyseus uses Express and a fork of [better-call](https://github.com/colyseus/better-call) as its HTTP routing libraries. You can use it to add your custom routes to your server.

```ts {15-17} filename="app.config.ts"
import { defineServer } from "colyseus";
import express from "express";

const server = defineServer({
    // ...
    express: (app) => {
        //
        // Include express middlewares (e.g. JSON body parser)
        //
        app.use(express.json({ limit: "100kb" }));

        //
        // Define your custom routes here
        //
        app.get("/hello_world", (req, res) => {
            res.json({ hello: "world" });
        });

    },
    // ...
});
```

<Callout type="info">
    For more information about Express, check out the [Express guides](https://expressjs.com/en/guide/routing.html).
</Callout>


## Parsing JSON bodies

Here's an example of how to handle JSON POST requests with both backend parsing and frontend usage:

```ts {11-30} filename="app.config.ts"
import { defineServer } from "colyseus";
import express from "express";

const server = defineServer({
    // ...
    express: (app) => {
        // Parse incoming JSON bodies
        app.use(express.json({ limit: "100kb" }));

        // Example: User profile update endpoint
        app.post("/api/user/profile", (req, res) => {
            const { name, email, preferences } = req.body;

            // Validate required fields
            if (!name || !email) {
                return res.status(400).json({
                    error: "Name and email are required"
                });
            }

            // Process the data (e.g., save to database)
            console.log("Updating user profile:", { name, email, preferences });

            // Return success response
            res.json({
                success: true,
                message: "Profile updated successfully",
                data: { name, email, preferences }
            });
        });
    },
    // ...
});
```

## CORS (Cross-Origin Resource Sharing)

CORS is enabled by default. 

<Callout type="info">
    **What is CORS?** - Cross-Origin Resource Sharing (CORS) is an HTTP-header based mechanism that allows a server to indicate any origins (domain, scheme, or port) other than its own from which a browser should permit loading resources. CORS also relies on a mechanism by which browsers make a "preflight" request to the server hosting the cross-origin resource, in order to check that the server will permit the actual request. In that preflight, the browser sends headers that indicate the HTTP method and headers that will be used in the actual request.

    See [MDN documentation on CORS for more information ↗](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
</Callout>

You may customize the default CORS headers if you need to:

```typescript
import { matchMaker } from "colyseus";

matchMaker.controller.DEFAULT_CORS_HEADERS = {
    'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept, Authorization',
    'Access-Control-Allow-Methods': 'GET,HEAD,PUT,PATCH,POST,DELETE',
    'Access-Control-Allow-Credentials': 'true',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Max-Age': '2592000',
    // ...
}
```

You may also return custom CORS headers based on request headers sent by the client:

```typescript
import { matchMaker } from "colyseus";

matchMaker.controller.getCorsHeaders = function(requestHeaders) {
    // check for 'requestHeaders' and return custom key-value headers here.
    return {};
}
```

### Frontend usage:

Use the `client.http.*` methods to perform HTTP requests to your server.

<Callout type="info">
    See [Client SDK → HTTP Requests](/client/#http-requests) for more details.
</Callout>

```ts {8-10,23-25} filename="client.ts"
import { Client } from "@colyseus/sdk";

const client = new Client("http://localhost:2567");

// Update user profile
async function updateProfile(name: string, email: string, preferences: any) {
    try {
        const response = await client.http.post("/api/user/profile", {
            body: { name, email, preferences }
        });

        console.log("Profile updated:", response);
        return response;
    } catch (error) {
        console.error("Failed to update profile:", error);
        throw error;
    }
}

// Submit game score
async function submitScore(playerId: string, score: number, level: number) {
    try {
        const response = await client.http.post("/api/game/score", {
            body: { playerId, score, level, timestamp: Date.now() }
        });

        console.log("Score submitted:", response);
        return response;
    } catch (error) {
        console.error("Failed to submit score:", error);
        throw error;
    }
}

// Usage examples
updateProfile("John Doe", "john@example.com", { theme: "dark" });
submitScore("player123", 1500, 5);
```

<Callout type="info">
    The `client.http.post()` method automatically handles JSON serialization and sets the appropriate `Content-Type` header. The backend `express.json()` middleware will parse the incoming JSON body into `req.body`.
</Callout>
